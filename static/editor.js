// Generated by CoffeeScript 1.4.0
(function() {
  var publish, redirect, throwerror, throwproblem;

  window.onerror = function(message, url, linenumber) {
    $(".errorbox").html("<div class=\"error\">" + linenumber + " : " + message + "</div>");
    return false;
  };

  window.setupeditor = function(args) {
    var converter, hidden, horizontal, html;
    hidden = false;
    horizontal = false;
    $("textarea#editor").html("Place your content here");
    $('textarea#editor').on('change keyup', function() {
      var html;
      if (hidden) {
        return;
      }
      $(".errorbox").html("");
      html = converter.makeHtml($("#editor").val());
      $("#result").html(html);
    });
    $('textarea#editor').focus();
    if (args[0] != null) {
      $('input#docname').val(args[0]);
    }
    if (args[1] != null) {
      $("#editor").val(args[1]);
    }
    $("#discard").click(redirect);
    $("#save").click(function() {
      var blob, data, downloadLink, exports, name;
      data = $("#editor").val();
      name = $('input#docname').val();
      if (!(name != null) || name === "") {
        name = "Untitled";
      }
      exports = {
        "data": data,
        "title": name
      };
      blob = new Blob([JSON.stringify(exports)], {
        type: 'application/json'
      });
      downloadLink = document.createElement("a");
      downloadLink.href = window.webkitURL.createObjectURL(blob);
      downloadLink.download = name + ".dd";
      downloadLink.click();
    });
    $("#btpublish").click(function() {
      var data, name;
      data = $("#editor").val();
      name = $('input#docname').val();
      if (!(name != null) || name === "") {
        name = "Untitled";
      }
      $("#publish").show();
      $("#dodoname").val(name);
    });
    $("#pbcancel").click(function() {
      return $("#publish").hide();
    });
    $("#pbpublish").click(function() {
      var surl;
      surl = $("#dodoname").val();
      if (!(surl != null) || surl === "") {
        return;
      }
      return $.getJSON("http://" + $("#dodourl").val() + "/api/user").done(publish).error(throwproblem);
    });
    $("#hide").click(function() {
      var an;
      hidden = !hidden;
      if (hidden) {
        $('#result').fadeOut("fast", function() {
          var an;
          an = horizontal ? {
            bottom: "50px"
          } : {
            width: "935px"
          };
          $('#edcontainer').animate(an);
          $("#hide").text("Show preview");
        });
      } else {
        an = horizontal ? {
          bottom: "51%"
        } : {
          width: "450px"
        };
        $('#edcontainer').animate(an, function() {
          $('#result').fadeIn("fast");
          $("#hide").text("Hide preview");
        });
      }
    });
    $("#switch").click(function() {
      if (hidden) {
        return;
      }
      horizontal = !horizontal;
      if (horizontal) {
        $('#result').animate({
          width: "918px",
          top: "50%"
        });
        return $('#edcontainer').animate({
          width: "938px",
          bottom: "51%"
        });
      } else {
        $('#result').animate({
          width: "460px",
          top: "60px"
        });
        return $('#edcontainer').animate({
          width: "450px",
          bottom: "50px"
        });
      }
    });
    converter = new Showdown.converter();
    html = converter.makeHtml($("#editor").val());
    return $("#result").html(html);
  };

  redirect = function(data) {
    location.href = document.URL.replace(/\/edit(.*)/, "");
  };

  throwerror = function(data) {
    alert("Check your console (and logs, if you can)!");
    console.log(data);
  };

  publish = function(data) {
    var formprop, input1, input2, name, newForm;
    name = $('input#docname').val();
    if (!(name != null) || name === "") {
      name = "Untitled";
    }
    formprop = {
      "action": "http://" + $("#dodourl").val() + "/" + data.name + "/" + $("#dodoname").val() + "/edit"
    };
    newForm = jQuery('<form>', formprop);
    input1 = jQuery('<input>', {
      'name': 'title',
      'value': name,
      'type': 'hidden'
    });
    input2 = jQuery('<input>', {
      'name': 'content',
      'value': $("#editor").val(),
      'type': 'hidden'
    });
    newForm.append(input1);
    newForm.append(input2);
    newForm.submit();
  };

  throwproblem = function(data) {
    return alert("You're not logged in or allowed into the specified Dodo service.");
  };

}).call(this);
